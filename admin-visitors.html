<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Visitor Analytics - Admin</title>
        <!-- WARNING: Do not use cdn.tailwindcss.com in production. Use Tailwind CLI or PostCSS for production builds. -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Chart.js for analytics charts -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            tailwind.config = {
                darkMode: 'class'
            }
        </script>
    </head>
    <body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8">Visitor Analytics</h1>
            
            <!-- Filter and Sort Controls -->
            <div class="flex flex-wrap gap-4 mb-6">
                <div>
                    <label for="dateRange" class="block text-sm font-medium mb-1">Date Range</label>
                    <select id="dateRange" class="rounded border-gray-300 dark:bg-gray-800 dark:text-gray-100">
                        <option value="today">Today</option>
                        <option value="last7">Last 7 Days</option>
                        <option value="thisMonth">This Month</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div>
                    <label for="sortBy" class="block text-sm font-medium mb-1">Sort By</label>
                    <select id="sortBy" class="rounded border-gray-300 dark:bg-gray-800 dark:text-gray-100">
                        <option value="recent">Most Recent</option>
                        <option value="active">Most Active</option>
                        <option value="country">Country</option>
                        <option value="device">Device</option>
                        <option value="referrer">Referrer</option>
                    </select>
                </div>
                <div>
                    <label for="filterBy" class="block text-sm font-medium mb-1">Filter By</label>
                    <select id="filterBy" class="rounded border-gray-300 dark:bg-gray-800 dark:text-gray-100">
                        <option value="all">All</option>
                        <option value="country">Country</option>
                        <option value="device">Device</option>
                        <option value="referrer">Referrer</option>
                    </select>
                </div>
                <div id="filterValueContainer" style="display:none">
                    <label for="filterValue" class="block text-sm font-medium mb-1">Value</label>
                    <input id="filterValue" class="rounded border-gray-300 dark:bg-gray-800 dark:text-gray-100" type="text" placeholder="Enter value..." />
                </div>
            </div>

            <!-- Robust Analytics Cards Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-users text-blue-600 dark:text-blue-400 mr-2"></i>
                        <h3 class="text-lg font-semibold">Total Visitors (All Time)</h3>
                    </div>
                    <div id="totalVisitors" class="text-3xl font-bold text-blue-600 dark:text-blue-400">Loading...</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-calendar-day text-green-600 dark:text-green-400 mr-2"></i>
                        <h3 class="text-lg font-semibold">Total Visitors (Today)</h3>
                    </div>
                    <div id="totalVisitorsToday" class="text-2xl font-bold text-green-600 dark:text-green-400">Loading...</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-clock text-orange-600 dark:text-orange-400 mr-2"></i>
                        <h3 class="text-lg font-semibold">Currently Online</h3>
                    </div>
                    <div id="currentlyOnline" class="text-3xl font-bold text-orange-600 dark:text-orange-400">Loading...</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-hourglass-half text-purple-600 dark:text-purple-400 mr-2"></i>
                        <h3 class="text-lg font-semibold">Active Last Hour</h3>
                    </div>
                    <div id="activeLastHour" class="text-3xl font-bold text-purple-600 dark:text-purple-400">Loading...</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-calendar-day text-pink-600 dark:text-pink-400 mr-2"></i>
                        <h3 class="text-lg font-semibold">Active Last Day</h3>
                    </div>
                    <div id="activeLastDay" class="text-3xl font-bold text-pink-600 dark:text-pink-400">Loading...</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-stopwatch text-indigo-600 dark:text-indigo-400 mr-2"></i>
                        <h3 class="text-lg font-semibold">Avg Session Duration</h3>
                    </div>
                    <div id="avgSessionDuration" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Loading...</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-bounce text-red-600 dark:text-red-400 mr-2"></i>
                        <h3 class="text-lg font-semibold">Bounce Rate</h3>
                    </div>
                    <div id="bounceRate" class="text-2xl font-bold text-red-600 dark:text-red-400">Loading...</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-undo text-teal-600 dark:text-teal-400 mr-2"></i>
                        <h3 class="text-lg font-semibold">Return Rate</h3>
                    </div>
                    <div id="returnRate" class="text-2xl font-bold text-teal-600 dark:text-teal-400">Loading...</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-layer-group text-yellow-600 dark:text-yellow-400 mr-2"></i>
                        <h3 class="text-lg font-semibold">Total Sessions</h3>
                    </div>
                    <div id="totalSessions" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">Loading...</div>
                </div>
                <!-- Recent Visitors Card -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow col-span-1 md:col-span-2 lg:col-span-4">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-user-clock text-blue-600 dark:text-blue-400 mr-2"></i>
                        <h3 class="text-xl font-semibold">Recent Visitors</h3>
                    </div>
                    <div id="recentVisitors" class="space-y-2">Loading...</div>
                </div>
                <!-- Hourly Traffic Chart -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow col-span-1 md:col-span-2 lg:col-span-2">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-chart-area text-purple-600 dark:text-purple-400 mr-2"></i>
                        <h3 class="text-xl font-semibold">Hourly Traffic</h3>
                    </div>
                    <canvas id="hourlyChart" width="400" height="200"></canvas>
                </div>
                <!-- Daily Traffic Chart -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow col-span-1 md:col-span-2 lg:col-span-2">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-calendar-day text-green-600 dark:text-green-400 mr-2"></i>
                        <h3 class="text-xl font-semibold">Daily Traffic</h3>
                    </div>
                    <canvas id="dailyChart" width="400" height="200"></canvas>
                </div>
                <!-- Monthly Traffic Chart -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow col-span-1 md:col-span-2 lg:col-span-2">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-calendar-alt text-blue-600 dark:text-blue-400 mr-2"></i>
                        <h3 class="text-xl font-semibold">Monthly Traffic</h3>
                    </div>
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                </div>
                <!-- Device Types Chart -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-mobile-alt text-indigo-600 dark:text-indigo-400 mr-2"></i>
                        <h3 class="text-xl font-semibold">Device Types</h3>
                    </div>
                    <canvas id="devicesChart" width="400" height="200"></canvas>
                </div>
                <!-- Browser Distribution Chart -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-browser text-orange-600 dark:text-orange-400 mr-2"></i>
                        <h3 class="text-xl font-semibold">Browser Distribution</h3>
                    </div>
                    <canvas id="browsersChart" width="400" height="200"></canvas>
                </div>
                <!-- Unique Visitors by Day Chart -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-user-check text-green-600 dark:text-green-400 mr-2"></i>
                        <h3 class="text-xl font-semibold">Unique Visitors by Day</h3>
                    </div>
                    <canvas id="uniqueDayChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- SEO/Keyword Tracking Section -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-8 w-full">
                <div class="flex items-center mb-4">
                    <i class="fas fa-search text-pink-600 dark:text-pink-400 mr-2"></i>
                    <h3 class="text-xl font-semibold">SEO & Keyword Tracking</h3>
                </div>
                <div id="seoKeywordsContainer">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr><th class="text-left py-2">Keyword</th><th class="text-left py-2">Engine</th><th class="text-left py-2">Count</th></tr>
                        </thead>
                        <tbody id="seoKeywordsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Raw Visitors Table Section with Controls -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-8 w-full">
                <div class="flex items-center mb-4">
                    <i class="fas fa-database text-blue-600 dark:text-blue-400 mr-2"></i>
                    <h3 class="text-xl font-semibold">Raw Visitor Data</h3>
                </div>
                <div class="flex flex-wrap gap-4 mb-4">
                    <div>
                        <label for="rawSortBy" class="block text-xs font-medium mb-1">Sort By</label>
                        <select id="rawSortBy" class="rounded border-gray-300 dark:bg-gray-800 dark:text-gray-100">
                            <option value="lastVisit">Last Visit</option>
                            <option value="firstVisit">First Visit</option>
                            <option value="ip">IP</option>
                            <option value="city">City</option>
                            <option value="country">Country</option>
                        </select>
                    </div>
                    <div>
                        <label for="rawFilterBy" class="block text-xs font-medium mb-1">Filter By</label>
                        <select id="rawFilterBy" class="rounded border-gray-300 dark:bg-gray-800 dark:text-gray-100">
                            <option value="none">None</option>
                            <option value="ip">IP</option>
                            <option value="city">City</option>
                            <option value="country">Country</option>
                        </select>
                    </div>
                    <div id="rawFilterValueContainer" style="display:none">
                        <label for="rawFilterValue" class="block text-xs font-medium mb-1">Value</label>
                        <input id="rawFilterValue" class="rounded border-gray-300 dark:bg-gray-800 dark:text-gray-100" type="text" placeholder="Enter value..." />
                    </div>
                    <div class="flex items-end">
                        <button onclick="exportRawVisitorsCSV()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-xs">Export CSV</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr>
                                <th class="text-left py-2">IP</th>
                                <th class="text-left py-2">City</th>
                                <th class="text-left py-2">Region</th>
                                <th class="text-left py-2">Country</th>
                                <th class="text-left py-2">ZIP</th>
                                <th class="text-left py-2">First Visit</th>
                                <th class="text-left py-2">Last Visit</th>
                                <th class="text-left py-2">Headers</th>
                            </tr>
                        </thead>
                        <tbody id="rawVisitorsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Modal for All Headers (Enhanced) -->
            <div id="headersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
                            <h3 class="text-lg font-semibold">Visitor Details & Headers</h3>
                            <button onclick="closeHeadersModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-4">
                            <div id="headersModalSummary" class="mb-4 text-sm"></div>
                            <pre id="headersModalContent" class="bg-gray-100 dark:bg-gray-700 p-3 rounded text-xs overflow-x-auto"></pre>
                            <button onclick="copyHeadersToClipboard()" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">Copy Headers</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Load visitor data
            async function loadVisitorData() {
                try {
                    const response = await fetch('/api/visitors?debug=true');
                    const data = await response.json();
                    
                    // Display total visitors
                    const totalCount = data.visitor_count || 0;
                    document.getElementById('totalVisitors').textContent = totalCount;
                    
                    // Display recent visitors
                    const visitorsList = data.visitors_list ? JSON.parse(data.visitors_list) : [];
                    const recentVisitors = visitorsList.slice(-5).reverse();
                    
                    const recentHtml = recentVisitors.map(visitor => `
                        <div class="flex justify-between items-center py-2 border-b dark:border-gray-700">
                            <div>
                                <div class="font-medium">${visitor.city || 'Unknown'}, ${visitor.country || 'Unknown'}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${visitor.ip}</div>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                ${new Date(visitor.lastVisit).toLocaleDateString()}
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('recentVisitors').innerHTML = recentHtml || 'No visitors yet';
                    
                    // Display all visitors in table
                    const tableHtml = visitorsList.map(visitor => `
                        <tr class="border-b dark:border-gray-700">
                            <td class="py-2 font-mono text-xs">${visitor.ip}</td>
                            <td class="py-2">${visitor.city || 'Unknown'}, ${visitor.region || ''} ${visitor.zip || ''} ${visitor.country || 'Unknown'}</td>
                            <td class="py-2">${new Date(visitor.firstVisit).toLocaleString()}</td>
                            <td class="py-2">${new Date(visitor.lastVisit).toLocaleString()}</td>
                            <td class="py-2">
                                <button onclick="showVisitorDetails('${JSON.stringify(visitor).replace(/'/g, "\\'")}')" 
                                        class="text-blue-500 hover:text-blue-700 text-xs">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                    document.getElementById('visitorsTable').innerHTML = tableHtml || '<tr><td colspan="5" class="py-4 text-center">No visitors yet</td></tr>';
                    
                } catch (error) {
                    console.error('Error loading visitor data:', error);
                    document.getElementById('totalVisitors').textContent = 'Error loading data';
                }
            }
            
            // Load raw KV data
            async function loadRawData() {
                try {
                    const response = await fetch('/api/visitors?debug=true');
                    const data = await response.json();
                    document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error('Error loading raw data:', error);
                    document.getElementById('rawData').textContent = 'Error loading raw data';
                }
            }
            
            // Load headers data
            async function loadHeaders() {
                try {
                    const response = await fetch('/api/visitors?headers=true');
                    const data = await response.json();
                    document.getElementById('headersData').textContent = JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error('Error loading headers:', error);
                    document.getElementById('headersData').textContent = 'Error loading headers';
                }
            }
            
            // Test geolocation
            async function testGeolocation() {
                try {
                    // First get headers
                    const headersResponse = await fetch('/api/visitors?headers=true');
                    const headers = await headersResponse.json();
                    
                    // Show geolocation-specific headers
                    const geoHeaders = {};
                    Object.keys(headers).forEach(key => {
                        if (key.startsWith('CF-IP')) {
                            geoHeaders[key] = headers[key];
                        }
                    });
                    
                    document.getElementById('headersData').textContent = 
                        'Geolocation Headers:\n' + JSON.stringify(geoHeaders, null, 2) + 
                        '\n\nAll Headers:\n' + JSON.stringify(headers, null, 2);
                } catch (error) {
                    console.error('Error testing geolocation:', error);
                    document.getElementById('headersData').textContent = 'Error testing geolocation';
                }
            }
            
            // Clear KV data
            async function clearKVData() {
                if (!confirm('Are you sure you want to clear all KV data? This cannot be undone.')) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/clear-kv?clear=true');
                    const data = await response.json();
                    document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
                    alert('KV data cleared successfully!');
                    loadVisitorData(); // Refresh the display
                } catch (error) {
                    console.error('Error clearing KV data:', error);
                    document.getElementById('rawData').textContent = 'Error clearing KV data: ' + error.message;
                }
            }
            
            // Test new system
            async function testNewSystem() {
                try {
                    const response = await fetch('/api/clear-kv?test=true');
                    const data = await response.json();
                    document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
                    alert('New system test completed! Check the raw data below.');
                    loadVisitorData(); // Refresh the display
                } catch (error) {
                    console.error('Error testing new system:', error);
                    document.getElementById('rawData').textContent = 'Error testing new system: ' + error.message;
                }
            }
            
            // Show visitor details
            function showVisitorDetails(visitorJson) {
                const visitor = JSON.parse(visitorJson);
                alert(`Visitor Details:\n\n` +
                    `IP: ${visitor.ip}\n` +
                    `City: ${visitor.city || 'Unknown'}\n` +
                    `Region: ${visitor.region || 'Unknown'}\n` +
                    `Country: ${visitor.country || 'Unknown'}\n` +
                    `ZIP: ${visitor.zip || 'Unknown'}\n` +
                    `Latitude: ${visitor.latitude || 'Unknown'}\n` +
                    `Longitude: ${visitor.longitude || 'Unknown'}\n` +
                    `Timezone: ${visitor.timezone || 'Unknown'}\n` +
                    `Continent: ${visitor.continent || 'Unknown'}\n` +
                    `First Visit: ${new Date(visitor.firstVisit).toLocaleString()}\n` +
                    `Last Visit: ${new Date(visitor.lastVisit).toLocaleString()}`);
            }
            
            // Only keep the robust analytics script for dashboard cards/charts
            async function loadAnalyticsData() {
                try {
                    const response = await fetch('/api/analytics?type=all');
                    const data = await response.json();

                    // Update cards
                    document.getElementById('totalVisitors').textContent = data.realtime.totalVisitors || 0;
                    // Today: use uniqueVisitors.byDay (last entry is today)
                    const todayUnique = data.uniqueVisitors.byDay[data.uniqueVisitors.byDay.length - 1];
                    document.getElementById('totalVisitorsToday').textContent = todayUnique ? todayUnique.count : 0;
                    document.getElementById('currentlyOnline').textContent = data.realtime.currentlyOnline || 0;
                    document.getElementById('activeLastHour').textContent = data.realtime.activeLastHour || 0;
                    document.getElementById('activeLastDay').textContent = data.realtime.activeLastDay || 0;
                    document.getElementById('avgSessionDuration').textContent = (data.engagement && typeof data.engagement.avgSessionDuration !== 'undefined') ? `${Math.floor(data.engagement.avgSessionDuration/60)}m ${data.engagement.avgSessionDuration%60}s` : '0m 0s';
                    document.getElementById('bounceRate').textContent = (data.engagement && typeof data.engagement.bounceRate !== 'undefined') ? `${data.engagement.bounceRate}%` : '0%';
                    document.getElementById('returnRate').textContent = (data.engagement && typeof data.engagement.returnRate !== 'undefined') ? `${data.engagement.returnRate}%` : '0%';
                    document.getElementById('totalSessions').textContent = data.engagement.totalSessions || 0;

                    // Hourly Traffic Chart
                    if (window.hourlyChartInstance) window.hourlyChartInstance.destroy();
                    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
                    window.hourlyChartInstance = new Chart(hourlyCtx, {
                        type: 'line',
                        data: {
                            labels: data.temporal.hourly.map(d => `${d.hour}:00`),
                            datasets: [{
                                label: 'Visitors',
                                data: data.temporal.hourly.map(d => d.count),
                                borderColor: '#8B5CF6',
                                backgroundColor: 'rgba(139,92,246,0.1)',
                                tension: 0.4
                            }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: true } } }
                    });

                    // Daily Traffic Chart
                    if (window.dailyChartInstance) window.dailyChartInstance.destroy();
                    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
                    window.dailyChartInstance = new Chart(dailyCtx, {
                        type: 'bar',
                        data: {
                            labels: data.temporal.daily.map(d => d.day),
                            datasets: [{
                                label: 'Visitors',
                                data: data.temporal.daily.map(d => d.count),
                                backgroundColor: '#10B981'
                            }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: true } } }
                    });

                    // Monthly Traffic Chart
                    if (window.monthlyChartInstance) window.monthlyChartInstance.destroy();
                    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
                    window.monthlyChartInstance = new Chart(monthlyCtx, {
                        type: 'bar',
                        data: {
                            labels: data.temporal.monthly.map(d => d.month),
                            datasets: [{
                                label: 'Visitors',
                                data: data.temporal.monthly.map(d => d.count),
                                backgroundColor: '#3B82F6'
                            }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: true } } }
                    });

                    // Device Types Chart
                    if (window.devicesChartInstance) window.devicesChartInstance.destroy();
                    const devicesCtx = document.getElementById('devicesChart').getContext('2d');
                    window.devicesChartInstance = new Chart(devicesCtx, {
                        type: 'pie',
                        data: {
                            labels: data.technical.devices.map(d => d.device),
                            datasets: [{
                                label: 'Devices',
                                data: data.technical.devices.map(d => d.count),
                                backgroundColor: ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6']
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });

                    // Browser Distribution Chart
                    if (window.browsersChartInstance) window.browsersChartInstance.destroy();
                    const browsersCtx = document.getElementById('browsersChart').getContext('2d');
                    window.browsersChartInstance = new Chart(browsersCtx, {
                        type: 'bar',
                        data: {
                            labels: data.technical.browsers.map(d => d.browser),
                            datasets: [{
                                label: 'Users',
                                data: data.technical.browsers.map(d => d.count),
                                backgroundColor: '#F59E0B'
                            }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: true } } }
                    });

                    // Unique Visitors by Day Chart
                    if (window.uniqueDayChartInstance) window.uniqueDayChartInstance.destroy();
                    const uniqueDayCtx = document.getElementById('uniqueDayChart').getContext('2d');
                    window.uniqueDayChartInstance = new Chart(uniqueDayCtx, {
                        type: 'bar',
                        data: {
                            labels: data.uniqueVisitors.byDay.map(d => d.period),
                            datasets: [{
                                label: 'Unique Visitors',
                                data: data.uniqueVisitors.byDay.map(d => d.count),
                                backgroundColor: '#6366F1'
                            }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: true } } }
                    });

                    // SEO/Keyword Tracking Table
                    const seoKeywordsTable = document.getElementById('seoKeywordsTable');
                    if (seoKeywordsTable) {
                        if (data.seoKeywords && data.seoKeywords.length > 0) {
                            seoKeywordsTable.innerHTML = data.seoKeywords.map(k => `<tr><td class='py-2'>${k.keyword}</td><td class='py-2'>${k.engine}</td><td class='py-2'>${k.count}</td></tr>`).join('');
                        } else {
                            seoKeywordsTable.innerHTML = `<tr><td colspan='3' class='py-2 text-center text-gray-500'>No keyword data yet</td></tr>`;
                        }
                    }

                } catch (error) {
                    console.error('Error loading analytics:', error);
                    document.getElementById('totalVisitors').textContent = 'Error loading data';
                }
            }
            
            // Load data on page load
            loadAnalyticsData();
        </script>
        <!-- Load and render raw visitors table -->
        <script>
            let _rawVisitorsList = [];
            let _rawVisitorsFiltered = [];
            let _rawVisitorsSortBy = 'lastVisit';
            let _rawVisitorsFilterBy = 'none';
            let _rawVisitorsFilterValue = '';

            document.getElementById('rawSortBy').addEventListener('change', e => {
                _rawVisitorsSortBy = e.target.value;
                renderRawVisitorsTable();
            });
            document.getElementById('rawFilterBy').addEventListener('change', e => {
                _rawVisitorsFilterBy = e.target.value;
                const show = _rawVisitorsFilterBy !== 'none';
                document.getElementById('rawFilterValueContainer').style.display = show ? '' : 'none';
                if (!show) _rawVisitorsFilterValue = '';
                renderRawVisitorsTable();
            });
            document.getElementById('rawFilterValue').addEventListener('input', e => {
                _rawVisitorsFilterValue = e.target.value;
                renderRawVisitorsTable();
            });

            async function loadRawVisitorsTable() {
                try {
                    const response = await fetch('/api/visitors?debug=true');
                    const data = await response.json();
                    _rawVisitorsList = data.visitors_list ? JSON.parse(data.visitors_list) : [];
                    window._allVisitorHeaders = _rawVisitorsList.map(v => v.allHeaders || {});
                    renderRawVisitorsTable();
                    renderAllVisitorsTable();
                } catch (error) {
                    document.getElementById('rawVisitorsTable').innerHTML = '<tr><td colspan="8" class="py-4 text-center text-red-500">Error loading data</td></tr>';
                    document.getElementById('visitorsTable').innerHTML = '<tr><td colspan="5" class="py-4 text-center text-red-500">Error loading data</td></tr>';
                }
            }

            function renderRawVisitorsTable() {
                // Filter
                _rawVisitorsFiltered = _rawVisitorsList.filter(v => {
                    if (_rawVisitorsFilterBy === 'none' || !_rawVisitorsFilterValue) return true;
                    const val = _rawVisitorsFilterValue.toLowerCase();
                    if (_rawVisitorsFilterBy === 'ip') return (v.ip || '').toLowerCase().includes(val);
                    if (_rawVisitorsFilterBy === 'city') return (v.city || '').toLowerCase().includes(val);
                    if (_rawVisitorsFilterBy === 'country') return (v.country || '').toLowerCase().includes(val);
                    return true;
                });
                // Sort
                _rawVisitorsFiltered.sort((a, b) => {
                    if (_rawVisitorsSortBy === 'lastVisit') return new Date(b.lastVisit) - new Date(a.lastVisit);
                    if (_rawVisitorsSortBy === 'firstVisit') return new Date(b.firstVisit) - new Date(a.firstVisit);
                    if (_rawVisitorsSortBy === 'ip') return (a.ip || '').localeCompare(b.ip || '');
                    if (_rawVisitorsSortBy === 'city') return (a.city || '').localeCompare(b.city || '');
                    if (_rawVisitorsSortBy === 'country') return (a.country || '').localeCompare(b.country || '');
                    return 0;
                });
                // Render
                const tableHtml = _rawVisitorsFiltered.map((visitor, idx) => `
                    <tr class="border-b dark:border-gray-700">
                        <td class="py-2 font-mono text-xs">${visitor.ip}</td>
                        <td class="py-2">${visitor.city || ''}</td>
                        <td class="py-2">${visitor.region || ''}</td>
                        <td class="py-2">${visitor.country || ''}</td>
                        <td class="py-2">${visitor.zip || ''}</td>
                        <td class="py-2">${visitor.firstVisit ? new Date(visitor.firstVisit).toLocaleString() : ''}</td>
                        <td class="py-2">${visitor.lastVisit ? new Date(visitor.lastVisit).toLocaleString() : ''}</td>
                        <td class="py-2">
                            <button onclick="showHeadersModal(${idx})" class="text-blue-500 hover:text-blue-700 text-xs">View</button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('rawVisitorsTable').innerHTML = tableHtml || '<tr><td colspan="8" class="py-4 text-center">No visitors yet</td></tr>';
            }

            function renderAllVisitorsTable() {
                const tableBody = document.getElementById('visitorsTable');
                if (!_rawVisitorsList.length) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center">No visitors yet</td></tr>';
                    return;
                }
                const tableHtml = _rawVisitorsList.map(visitor => `
                    <tr class="border-b dark:border-gray-700">
                        <td class="py-2 font-mono text-xs">${visitor.ip}</td>
                        <td class="py-2">${visitor.city || 'Unknown'}, ${visitor.region || ''} ${visitor.zip || ''} ${visitor.country || 'Unknown'}</td>
                        <td class="py-2">${visitor.firstVisit ? new Date(visitor.firstVisit).toLocaleString() : ''}</td>
                        <td class="py-2">${visitor.lastVisit ? new Date(visitor.lastVisit).toLocaleString() : ''}</td>
                        <td class="py-2">
                            <button onclick="showVisitorDetails('${JSON.stringify(visitor).replace(/'/g, "\\'")}')" class="text-blue-500 hover:text-blue-700 text-xs">View Details</button>
                        </td>
                    </tr>
                `).join('');
                tableBody.innerHTML = tableHtml;
            }

            function exportRawVisitorsCSV() {
                if (!_rawVisitorsFiltered.length) return;
                const header = ['IP','City','Region','Country','ZIP','First Visit','Last Visit'];
                const rows = _rawVisitorsFiltered.map(v => [
                    v.ip, v.city, v.region, v.country, v.zip,
                    v.firstVisit ? new Date(v.firstVisit).toLocaleString() : '',
                    v.lastVisit ? new Date(v.lastVisit).toLocaleString() : ''
                ]);
                const csv = [header, ...rows].map(r => r.map(x => '"'+(x||'')+'"').join(',')).join('\n');
                const blob = new Blob([csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'raw_visitors.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function showHeadersModal(idx) {
                const visitor = _rawVisitorsFiltered[idx] || {};
                const headers = window._allVisitorHeaders && window._allVisitorHeaders[idx] ? window._allVisitorHeaders[idx] : {};
                // Show summary
                document.getElementById('headersModalSummary').innerHTML = `
                    <div><b>IP:</b> ${visitor.ip || ''}</div>
                    <div><b>City:</b> ${visitor.city || ''}</div>
                    <div><b>Region:</b> ${visitor.region || ''}</div>
                    <div><b>Country:</b> ${visitor.country || ''}</div>
                    <div><b>ZIP:</b> ${visitor.zip || ''}</div>
                    <div><b>First Visit:</b> ${visitor.firstVisit ? new Date(visitor.firstVisit).toLocaleString() : ''}</div>
                    <div><b>Last Visit:</b> ${visitor.lastVisit ? new Date(visitor.lastVisit).toLocaleString() : ''}</div>
                `;
                document.getElementById('headersModalContent').textContent = JSON.stringify(headers, null, 2);
                document.getElementById('headersModal').classList.remove('hidden');
            }
            function closeHeadersModal() {
                document.getElementById('headersModal').classList.add('hidden');
            }
            function copyHeadersToClipboard() {
                const text = document.getElementById('headersModalContent').textContent;
                navigator.clipboard.writeText(text);
                alert('Headers copied to clipboard!');
            }
            // Load on page load
            loadRawVisitorsTable();
        </script>
        <!-- Load and render recent visitors card (using raw visitors for now) -->
        <script>
            async function loadRecentVisitorsCard() {
                try {
                    const response = await fetch('/api/visitors?debug=true');
                    const data = await response.json();
                    const visitorsList = data.visitors_list ? JSON.parse(data.visitors_list) : [];
                    const recentVisitors = visitorsList.slice(-5).reverse();
                    const recentHtml = recentVisitors.map(visitor => `
                        <div class="flex justify-between items-center py-2 border-b dark:border-gray-700">
                            <div>
                                <div class="font-medium">${visitor.city || 'Unknown'}, ${visitor.country || 'Unknown'}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${visitor.ip}</div>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                ${visitor.lastVisit ? new Date(visitor.lastVisit).toLocaleString() : ''}
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('recentVisitors').innerHTML = recentHtml || '<div class="text-gray-500 text-center">No visitors yet</div>';
                } catch (error) {
                    document.getElementById('recentVisitors').innerHTML = '<div class="text-red-500 text-center">Error loading recent visitors</div>';
                }
            }
            // Load on page load
            loadRecentVisitorsCard();
        </script>
    </body>
</html>