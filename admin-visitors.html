<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Visitor Analytics - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8 flex items-center">
            <i class="fas fa-chart-line text-blue-600 dark:text-blue-400 mr-3"></i>
            Comprehensive Visitor Analytics
        </h1>
        
        <!-- Real-time Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-2">
                    <i class="fas fa-users text-blue-600 dark:text-blue-400 mr-2"></i>
                    <h3 class="text-lg font-semibold">Total Visitors</h3>
                </div>
                <div id="totalVisitors" class="text-3xl font-bold text-blue-600 dark:text-blue-400">Loading...</div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-2">
                    <i class="fas fa-circle text-green-600 dark:text-green-400 mr-2"></i>
                    <h3 class="text-lg font-semibold">Currently Online</h3>
                </div>
                <div id="currentlyOnline" class="text-3xl font-bold text-green-600 dark:text-green-400">Loading...</div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-2">
                    <i class="fas fa-clock text-orange-600 dark:text-orange-400 mr-2"></i>
                    <h3 class="text-lg font-semibold">Active Last Hour</h3>
                </div>
                <div id="activeLastHour" class="text-3xl font-bold text-orange-600 dark:text-orange-400">Loading...</div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-2">
                    <i class="fas fa-calendar-day text-purple-600 dark:text-purple-400 mr-2"></i>
                    <h3 class="text-lg font-semibold">Active Last Day</h3>
                </div>
                <div id="activeLastDay" class="text-3xl font-bold text-purple-600 dark:text-purple-400">Loading...</div>
            </div>
        </div>

        <!-- Engagement Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-2">
                    <i class="fas fa-stopwatch text-indigo-600 dark:text-indigo-400 mr-2"></i>
                    <h3 class="text-lg font-semibold">Avg Session Duration</h3>
                </div>
                <div id="avgSessionDuration" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Loading...</div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-2">
                    <i class="fas fa-bounce text-red-600 dark:text-red-400 mr-2"></i>
                    <h3 class="text-lg font-semibold">Bounce Rate</h3>
                </div>
                <div id="bounceRate" class="text-2xl font-bold text-red-600 dark:text-red-400">Loading...</div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-2">
                    <i class="fas fa-undo text-teal-600 dark:text-teal-400 mr-2"></i>
                    <h3 class="text-lg font-semibold">Return Rate</h3>
                </div>
                <div id="returnRate" class="text-2xl font-bold text-teal-600 dark:text-teal-400">Loading...</div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-2">
                    <i class="fas fa-layer-group text-yellow-600 dark:text-yellow-400 mr-2"></i>
                    <h3 class="text-lg font-semibold">Total Sessions</h3>
                </div>
                <div id="totalSessions" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">Loading...</div>
            </div>
        </div>

        <!-- Recent Visitors & Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Recent Visitors -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-4">
                    <i class="fas fa-user-clock text-blue-600 dark:text-blue-400 mr-2"></i>
                    <h3 class="text-xl font-semibold">Recent Visitors</h3>
                </div>
                <div id="recentVisitors" class="space-y-2">Loading...</div>
            </div>
            
            <!-- Geographic Analytics -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-4">
                    <i class="fas fa-globe text-green-600 dark:text-green-400 mr-2"></i>
                    <h3 class="text-xl font-semibold">Top Countries</h3>
                </div>
                <canvas id="countriesChart" width="400" height="200"></canvas>
            </div>
            
            <!-- Temporal Analytics -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-4">
                    <i class="fas fa-chart-area text-purple-600 dark:text-purple-400 mr-2"></i>
                    <h3 class="text-xl font-semibold">Hourly Traffic</h3>
                </div>
                <canvas id="hourlyChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Device Analytics -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-4">
                    <i class="fas fa-mobile-alt text-indigo-600 dark:text-indigo-400 mr-2"></i>
                    <h3 class="text-xl font-semibold">Device Types</h3>
                </div>
                <canvas id="devicesChart" width="400" height="200"></canvas>
            </div>
            
            <!-- Browser Analytics -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-4">
                    <i class="fas fa-browser text-orange-600 dark:text-orange-400 mr-2"></i>
                    <h3 class="text-xl font-semibold">Browser Distribution</h3>
                </div>
                <canvas id="browsersChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Detailed Analytics Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Top Cities -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-4">
                    <i class="fas fa-map-marker-alt text-red-600 dark:text-red-400 mr-2"></i>
                    <h3 class="text-xl font-semibold">Top Cities</h3>
                </div>
                <div id="topCities" class="space-y-2">Loading...</div>
            </div>
            
            <!-- Visit Patterns -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center mb-4">
                    <i class="fas fa-chart-pie text-teal-600 dark:text-teal-400 mr-2"></i>
                    <h3 class="text-xl font-semibold">Visit Patterns</h3>
                </div>
                <div id="visitPatterns" class="space-y-2">Loading...</div>
            </div>
        </div>

        <!-- Page Views Analytics -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-8">
            <div class="flex items-center mb-4">
                <i class="fas fa-file-alt text-blue-600 dark:text-blue-400 mr-2"></i>
                <h3 class="text-xl font-semibold">Page Views & Session Details</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b dark:border-gray-700">
                            <th class="text-left py-2">
                                <i class="fas fa-network-wired mr-1"></i>IP Address
                            </th>
                            <th class="text-left py-2">
                                <i class="fas fa-map-marker-alt mr-1"></i>Location
                            </th>
                            <th class="text-left py-2">
                                <i class="fas fa-file mr-1"></i>Pages Viewed
                            </th>
                            <th class="text-left py-2">
                                <i class="fas fa-clock mr-1"></i>Session Duration
                            </th>
                            <th class="text-left py-2">
                                <i class="fas fa-mobile-alt mr-1"></i>Device
                            </th>
                            <th class="text-left py-2">
                                <i class="fas fa-eye mr-1"></i>Details
                            </th>
                        </tr>
                    </thead>
                    <tbody id="visitorsTable">
                        <tr><td colspan="6" class="py-4 text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Referrer Analytics -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-8">
            <div class="flex items-center mb-4">
                <i class="fas fa-link text-pink-600 dark:text-pink-400 mr-2"></i>
                <h3 class="text-xl font-semibold">Top Referrers</h3>
            </div>
            <canvas id="referrerChart" height="120"></canvas>
            <div class="overflow-x-auto mt-4">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr><th class="text-left py-2">Referrer</th><th class="text-left py-2">Visitors</th></tr>
                    </thead>
                    <tbody id="referrerTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Visitor Details Modal -->
        <div id="visitorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between p-6 border-b dark:border-gray-700">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-blue-600 dark:text-blue-400 mr-2"></i>
                            <h3 class="text-xl font-semibold">Visitor Details</h3>
                        </div>
                        <button onclick="closeVisitorModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Modal Body -->
                    <div class="p-6">
                        <div id="visitorDetails" class="space-y-6">
                            <!-- Loading state -->
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="mt-2 text-gray-500">Loading visitor details...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        // Load comprehensive analytics data
        async function loadAnalyticsData() {
            try {
                const response = await fetch('/api/analytics?type=all');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Analytics error:', data.error);
                    return;
                }

                // Update real-time stats
                updateRealTimeStats(data.realtime);
                
                // Update engagement metrics
                updateEngagementMetrics(data.engagement);
                
                // Create charts
                createCharts(data);
                
                // Update detailed tables
                updateDetailedTables(data);
                
                // Load visitor table and recent visitors
                loadVisitorTable();
                loadRecentVisitors();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Update real-time statistics
        function updateRealTimeStats(realtime) {
            document.getElementById('totalVisitors').textContent = realtime.totalVisitors || 0;
            document.getElementById('currentlyOnline').textContent = realtime.currentlyOnline || 0;
            document.getElementById('activeLastHour').textContent = realtime.activeLastHour || 0;
            document.getElementById('activeLastDay').textContent = realtime.activeLastDay || 0;
        }

        // Update engagement metrics
        function updateEngagementMetrics(engagement) {
            const formatDuration = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}m ${secs}s`;
            };

            document.getElementById('avgSessionDuration').textContent = formatDuration(engagement.avgSessionDuration || 0);
            document.getElementById('bounceRate').textContent = `${engagement.bounceRate || 0}%`;
            document.getElementById('returnRate').textContent = `${engagement.returnRate || 0}%`;
            document.getElementById('totalSessions').textContent = engagement.totalSessions || 0;
        }

        // Load recent visitors
        async function loadRecentVisitors() {
            try {
                const response = await fetch('/api/visitors?debug=true');
                const data = await response.json();
                
                const visitorsList = data.visitors_list ? JSON.parse(data.visitors_list) : [];
                const recentVisitors = visitorsList.slice(-5).reverse();
                
                const recentHtml = recentVisitors.map(visitor => {
                    const deviceIcon = getDeviceIcon(visitor.deviceInfo?.deviceType);
                    const pageCount = visitor.pageViews ? visitor.pageViews.length : 0;
                    
                    return `
                        <div class="flex justify-between items-center py-2 border-b dark:border-gray-700">
                            <div class="flex items-center">
                                <i class="${deviceIcon} text-gray-400 mr-2"></i>
                                <div>
                                    <div class="font-medium">${visitor.city || 'Unknown'}, ${visitor.country || 'Unknown'}</div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">${pageCount} pages • ${maskIP(visitor.ip)}</div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                <i class="fas fa-clock mr-1"></i>
                                ${new Date(visitor.lastVisit).toLocaleDateString()}
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('recentVisitors').innerHTML = recentHtml || '<p class="text-gray-500 text-center">No visitors yet</p>';
                
            } catch (error) {
                console.error('Error loading recent visitors:', error);
            }
        }

        // Get device icon
        function getDeviceIcon(deviceType) {
            switch(deviceType) {
                case 'mobile': return 'fas fa-mobile-alt';
                case 'tablet': return 'fas fa-tablet-alt';
                default: return 'fas fa-desktop';
            }
        }

        // Create charts
        function createCharts(data) {
            // Countries Chart
            const countriesCtx = document.getElementById('countriesChart').getContext('2d');
            charts.countries = new Chart(countriesCtx, {
                type: 'doughnut',
                data: {
                    labels: data.geographic.topCountries.map(item => item.country),
                    datasets: [{
                        data: data.geographic.topCountries.map(item => item.count),
                        backgroundColor: [
                            '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
                            '#06B6D4', '#F97316', '#84CC16', '#EC4899', '#6366F1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Hourly Chart
            const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
            charts.hourly = new Chart(hourlyCtx, {
                type: 'line',
                data: {
                    labels: data.temporal.hourly.map(item => `${item.hour}:00`),
                    datasets: [{
                        label: 'Visitors',
                        data: data.temporal.hourly.map(item => item.count),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Devices Chart
            const devicesCtx = document.getElementById('devicesChart').getContext('2d');
            charts.devices = new Chart(devicesCtx, {
                type: 'pie',
                data: {
                    labels: data.technical.devices.map(item => item.device),
                    datasets: [{
                        data: data.technical.devices.map(item => item.count),
                        backgroundColor: ['#3B82F6', '#EF4444', '#10B981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Browsers Chart
            const browsersCtx = document.getElementById('browsersChart').getContext('2d');
            charts.browsers = new Chart(browsersCtx, {
                type: 'bar',
                data: {
                    labels: data.technical.browsers.map(item => item.browser),
                    datasets: [{
                        label: 'Users',
                        data: data.technical.browsers.map(item => item.count),
                        backgroundColor: '#8B5CF6'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update detailed tables
        function updateDetailedTables(data) {
            // Top Cities
            const topCitiesHtml = data.geographic.topCities.map((city, index) => `
                <div class="flex justify-between items-center py-2 border-b dark:border-gray-700">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-500 w-6">${index + 1}</span>
                        <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                        <span class="font-medium">${city.city}</span>
                    </div>
                    <span class="text-sm text-gray-500">${city.count} visitors</span>
                </div>
            `).join('');
            document.getElementById('topCities').innerHTML = topCitiesHtml;

            // Visit Patterns
            const patternsHtml = Object.entries(data.behavioral.visitPatterns).map(([time, count]) => {
                const icon = getTimeIcon(time);
                return `
                    <div class="flex justify-between items-center py-2 border-b dark:border-gray-700">
                        <div class="flex items-center">
                            <i class="${icon} text-teal-500 mr-2"></i>
                            <span class="font-medium capitalize">${time}</span>
                        </div>
                        <span class="text-sm text-gray-500">${count} visits</span>
                    </div>
                `;
            }).join('');
            document.getElementById('visitPatterns').innerHTML = patternsHtml;
        }

        // Get time icon
        function getTimeIcon(time) {
            switch(time) {
                case 'morning': return 'fas fa-sun';
                case 'afternoon': return 'fas fa-sun';
                case 'evening': return 'fas fa-moon';
                case 'night': return 'fas fa-moon';
                default: return 'fas fa-clock';
            }
        }

        // Load visitor table with page views
        async function loadVisitorTable() {
            try {
                const response = await fetch('/api/visitors?debug=true');
                const data = await response.json();
                
                const visitorsList = data.visitors_list ? JSON.parse(data.visitors_list) : [];
                
                const tableHtml = visitorsList.map(visitor => {
                    const pageCount = visitor.pageViews ? visitor.pageViews.length : 0;
                    const sessionDuration = calculateTotalSessionDuration(visitor);
                    const device = visitor.deviceInfo ? visitor.deviceInfo.deviceType : 'Unknown';
                    const deviceIcon = getDeviceIcon(device);
                    
                    return `
                        <tr class="border-b dark:border-gray-700">
                            <td class="py-2 font-mono text-xs">
                                <i class="fas fa-network-wired mr-1"></i>${maskIP(visitor.ip)}
                            </td>
                            <td class="py-2">
                                <i class="fas fa-map-marker-alt mr-1"></i>${visitor.city || 'Unknown'}, ${visitor.country || 'Unknown'}
                            </td>
                            <td class="py-2">
                                <i class="fas fa-file mr-1"></i>${pageCount} pages
                            </td>
                            <td class="py-2">
                                <i class="fas fa-clock mr-1"></i>${formatDuration(sessionDuration)}
                            </td>
                            <td class="py-2 capitalize">
                                <i class="${deviceIcon} mr-1"></i>${device}
                            </td>
                            <td class="py-2">
                                <button onclick="showVisitorDetails('${JSON.stringify(visitor).replace(/'/g, "\\'")}')" 
                                        class="text-blue-500 hover:text-blue-700 text-xs">
                                    <i class="fas fa-eye mr-1"></i>View Details
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('visitorsTable').innerHTML = tableHtml || '<tr><td colspan="6" class="py-4 text-center">No visitors yet</td></tr>';
                
            } catch (error) {
                console.error('Error loading visitor table:', error);
            }
        }

        // Calculate total session duration
        function calculateTotalSessionDuration(visitor) {
            if (!visitor.sessions) return 0;
            return visitor.sessions.reduce((total, session) => total + (session.duration || 0), 0);
        }

        // Format duration
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        }

        // Mask IP address
        function maskIP(ip) {
            if (!ip) return 'Unknown';
            const parts = ip.split('.');
            if (parts.length === 4) {
                return `${parts[0]}.${parts[1]}.***.***`;
            }
            return ip.substring(0, 8) + '...';
        }

        // Show visitor details modal with page views
        function showVisitorDetails(visitorJson) {
            const visitor = JSON.parse(visitorJson);
            const modal = document.getElementById('visitorModal');
            const detailsContainer = document.getElementById('visitorDetails');
            
            const detailsHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-3">
                                <i class="fas fa-info-circle mr-2"></i>Basic Information
                            </h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="font-medium"><i class="fas fa-network-wired mr-2"></i>IP Address:</span>
                                    <span class="font-mono text-sm">${maskIP(visitor.ip)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium"><i class="fas fa-map-marker-alt mr-2"></i>City:</span>
                                    <span>${visitor.city || 'Unknown'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium"><i class="fas fa-globe mr-2"></i>Country:</span>
                                    <span>${visitor.country || 'Unknown'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium"><i class="fas fa-mobile-alt mr-2"></i>Device:</span>
                                    <span>${visitor.deviceInfo ? visitor.deviceInfo.deviceType : 'Unknown'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium"><i class="fas fa-browser mr-2"></i>Browser:</span>
                                    <span>${visitor.deviceInfo ? visitor.deviceInfo.browser : 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Visit Information -->
                        <div>
                            <h4 class="text-lg font-semibold text-purple-600 dark:text-purple-400 mb-3">
                                <i class="fas fa-chart-line mr-2"></i>Visit Information
                            </h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="font-medium"><i class="fas fa-users mr-2"></i>Total Visits:</span>
                                    <span>${visitor.visitCount || 1}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium"><i class="fas fa-layer-group mr-2"></i>Sessions:</span>
                                    <span>${visitor.sessionCount || 1}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium"><i class="fas fa-calendar-plus mr-2"></i>First Visit:</span>
                                    <span class="text-sm">${new Date(visitor.firstVisit).toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium"><i class="fas fa-calendar-check mr-2"></i>Last Visit:</span>
                                    <span class="text-sm">${new Date(visitor.lastVisit).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Page Views -->
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-lg font-semibold text-green-600 dark:text-green-400 mb-3">
                                <i class="fas fa-file-alt mr-2"></i>Page Views (${visitor.pageViews ? visitor.pageViews.length : 0})
                            </h4>
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                                ${visitor.pageViews ? visitor.pageViews.map((pageView, index) => `
                                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="font-medium">
                                                    <i class="fas fa-file mr-2"></i>${pageView.page}
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    <i class="fas fa-clock mr-1"></i>${new Date(pageView.timestamp).toLocaleString()}
                                                </div>
                                            </div>
                                            <span class="text-xs text-gray-400">#${index + 1}</span>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-500"><i class="fas fa-exclamation-triangle mr-2"></i>No page views recorded</p>'}
                            </div>
                        </div>
                        
                        <!-- Session Details -->
                        <div>
                            <h4 class="text-lg font-semibold text-orange-600 dark:text-orange-400 mb-3">
                                <i class="fas fa-stopwatch mr-2"></i>Session Details
                            </h4>
                            <div class="space-y-2 max-h-32 overflow-y-auto">
                                ${visitor.sessions ? visitor.sessions.map((session, index) => `
                                    <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded text-sm">
                                        <div class="flex justify-between">
                                            <span><i class="fas fa-layer-group mr-1"></i>Session ${index + 1}</span>
                                            <span><i class="fas fa-clock mr-1"></i>${formatDuration(session.duration || 0)}</span>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-500"><i class="fas fa-exclamation-triangle mr-2"></i>No session data</p>'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Raw Data (Collapsible) -->
                <div class="mt-6">
                    <button onclick="toggleRawData()" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium">
                        <i class="fas fa-code mr-1"></i>Show Raw Data ▼
                    </button>
                    <div id="rawVisitorData" class="hidden mt-3">
                        <pre class="bg-gray-100 dark:bg-gray-700 p-3 rounded text-xs overflow-x-auto">${JSON.stringify(visitor, null, 2)}</pre>
                    </div>
                </div>
            `;
            
            detailsContainer.innerHTML = detailsHtml;
            modal.classList.remove('hidden');
        }

        // Close visitor modal
        function closeVisitorModal() {
            document.getElementById('visitorModal').classList.add('hidden');
        }

        // Toggle raw data visibility
        function toggleRawData() {
            const rawData = document.getElementById('rawVisitorData');
            const button = event.target;
            
            if (rawData.classList.contains('hidden')) {
                rawData.classList.remove('hidden');
                button.innerHTML = '<i class="fas fa-code mr-1"></i>Hide Raw Data ▲';
            } else {
                rawData.classList.add('hidden');
                button.innerHTML = '<i class="fas fa-code mr-1"></i>Show Raw Data ▼';
            }
        }

        // Close modal when clicking outside
        document.getElementById('visitorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVisitorModal();
            }
        });

        // Auto-refresh analytics every 30 seconds
        setInterval(loadAnalyticsData, 30000);

        // Load data on page load
        loadAnalyticsData();

        // Fetch and render referrer analytics
        fetch('functions/api/analytics.js?type=referrer')
          .then(res => res.json())
          .then(data => {
            // Render Chart.js bar chart
            const ctx = document.getElementById('referrerChart').getContext('2d');
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: data.map(d => d.referrer),
                datasets: [{
                  label: 'Visitors',
                  data: data.map(d => d.count),
                  backgroundColor: 'rgba(236,72,153,0.7)'
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { ticks: { color: '#111' } }, y: { beginAtZero: true, ticks: { color: '#111' } } }
              }
            });
            // Render table
            document.getElementById('referrerTable').innerHTML =
              data.map(d => `<tr><td class='py-2'>${d.referrer}</td><td class='py-2'>${d.count}</td></tr>`).join('');
          });
    </script>
</body>
</html> 